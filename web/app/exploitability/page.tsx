"use client";

import { useState, useCallback } from "react";
import { createApiClient, getErrorMessage } from "@/lib/apiClient";
import { getStoredToken } from "@/lib/api";
import type { ExploitabilityOutput } from "@/lib/types";
import ErrorAlert from "@/app/components/ErrorAlert";

const SUMMARY_MAX = 2000;
const REPO_MAX = 500;
const DEP_MAX = 100;
const EXPOSURE_MAX = 300;
const CVSS_MIN = 0;
const CVSS_MAX = 10;

type ExploitabilityStatus = "idle" | "submitting" | "success" | "error";

export default function ExploitabilityPage() {
  const [vulnerabilitySummary, setVulnerabilitySummary] = useState("");
  const [cvssScore, setCvssScore] = useState("");
  const [repoContext, setRepoContext] = useState("");
  const [dependencyType, setDependencyType] = useState("");
  const [exposureFlags, setExposureFlags] = useState("");
  const [status, setStatus] = useState<ExploitabilityStatus>("idle");
  const [response, setResponse] = useState<ExploitabilityOutput | null>(null);
  const [errorMessage, setErrorMessage] = useState<string | null>(null);

  const handleSummaryChange = useCallback((e: React.ChangeEvent<HTMLTextAreaElement>) => {
    setVulnerabilitySummary((e.target.value ?? "").slice(0, SUMMARY_MAX));
  }, []);
  const handleCvssChange = useCallback((e: React.ChangeEvent<HTMLInputElement>) => {
    setCvssScore(e.target.value ?? "");
  }, []);
  const handleRepoChange = useCallback((e: React.ChangeEvent<HTMLInputElement>) => {
    setRepoContext((e.target.value ?? "").slice(0, REPO_MAX));
  }, []);
  const handleDependencyChange = useCallback((e: React.ChangeEvent<HTMLInputElement>) => {
    setDependencyType((e.target.value ?? "").slice(0, DEP_MAX));
  }, []);
  const handleExposureChange = useCallback((e: React.ChangeEvent<HTMLInputElement>) => {
    setExposureFlags((e.target.value ?? "").slice(0, EXPOSURE_MAX));
  }, []);

  const handleSubmit = useCallback(
    async (e: React.FormEvent<HTMLFormElement>) => {
      e.preventDefault();
      const summary = vulnerabilitySummary.trim();
      if (summary.length === 0) {
        setErrorMessage("Vulnerability summary is required.");
        setStatus("error");
        return;
      }
      const cvss = Number(cvssScore);
      if (Number.isNaN(cvss) || cvss < CVSS_MIN || cvss > CVSS_MAX) {
        setErrorMessage(`CVSS score must be between ${CVSS_MIN} and ${CVSS_MAX}.`);
        setStatus("error");
        return;
      }

      setStatus("submitting");
      setResponse(null);
      setErrorMessage(null);
      try {
        const client = createApiClient({ token: getStoredToken() });
        const body = await client.postExploitability({
          vulnerability_summary: summary,
          cvss_score: cvss,
          repo_context: repoContext.trim() || "",
          dependency_type: dependencyType.trim() || "",
          exposure_flags: exposureFlags.trim() || "",
        });
        setResponse(body);
        setStatus("success");
      } catch (err) {
        setErrorMessage(getErrorMessage(err));
        setStatus("error");
      }
    },
    [vulnerabilitySummary, cvssScore, repoContext, dependencyType, exposureFlags]
  );

  return (
    <main style={{ padding: "2rem", maxWidth: "36rem", margin: "0 auto" }}>
      <h1 style={{ fontSize: "1.25rem", marginBottom: "1rem" }}>Exploitability</h1>
      <form onSubmit={handleSubmit}>
        <div style={{ marginBottom: "1rem" }}>
          <label htmlFor="exp-summary" style={{ display: "block", marginBottom: "0.5rem" }}>
            Vulnerability summary (required)
          </label>
          <textarea
            id="exp-summary"
            value={vulnerabilitySummary}
            onChange={handleSummaryChange}
            maxLength={SUMMARY_MAX}
            rows={3}
            required
            aria-label="Vulnerability summary"
            disabled={status === "submitting"}
            style={{ width: "100%", maxWidth: "28rem", padding: "0.375rem 0.5rem" }}
          />
        </div>
        <div style={{ marginBottom: "1rem" }}>
          <label htmlFor="exp-cvss" style={{ display: "block", marginBottom: "0.5rem" }}>
            CVSS score (0–10, required)
          </label>
          <input
            id="exp-cvss"
            type="number"
            min={CVSS_MIN}
            max={CVSS_MAX}
            step="0.1"
            value={cvssScore}
            onChange={handleCvssChange}
            aria-label="CVSS score"
            disabled={status === "submitting"}
            style={{ width: "8rem", padding: "0.375rem 0.5rem" }}
          />
        </div>
        <div style={{ marginBottom: "1rem" }}>
          <label htmlFor="exp-repo" style={{ display: "block", marginBottom: "0.5rem" }}>
            Repo context (optional)
          </label>
          <input
            id="exp-repo"
            type="text"
            value={repoContext}
            onChange={handleRepoChange}
            maxLength={REPO_MAX}
            aria-label="Repo context"
            disabled={status === "submitting"}
            style={{ width: "100%", maxWidth: "28rem", padding: "0.375rem 0.5rem" }}
          />
        </div>
        <div style={{ marginBottom: "1rem" }}>
          <label htmlFor="exp-dep" style={{ display: "block", marginBottom: "0.5rem" }}>
            Dependency type (optional)
          </label>
          <input
            id="exp-dep"
            type="text"
            value={dependencyType}
            onChange={handleDependencyChange}
            maxLength={DEP_MAX}
            aria-label="Dependency type"
            disabled={status === "submitting"}
            style={{ width: "100%", maxWidth: "20rem", padding: "0.375rem 0.5rem" }}
          />
        </div>
        <div style={{ marginBottom: "1rem" }}>
          <label htmlFor="exp-exposure" style={{ display: "block", marginBottom: "0.5rem" }}>
            Exposure flags (optional)
          </label>
          <input
            id="exp-exposure"
            type="text"
            value={exposureFlags}
            onChange={handleExposureChange}
            maxLength={EXPOSURE_MAX}
            aria-label="Exposure flags"
            disabled={status === "submitting"}
            style={{ width: "100%", maxWidth: "28rem", padding: "0.375rem 0.5rem" }}
          />
        </div>
        <button
          type="submit"
          disabled={status === "submitting"}
          aria-busy={status === "submitting"}
          aria-label={status === "submitting" ? "Running exploitability" : "Run exploitability"}
        >
          {status === "submitting" ? "Running…" : "Run exploitability"}
        </button>
      </form>
      {status === "error" && errorMessage !== null && errorMessage !== "" && (
        <ErrorAlert message={errorMessage} />
      )}
      {status === "success" && response !== null && (
        <div style={{ marginTop: "1.5rem", padding: "1rem", border: "1px solid #e5e7eb", borderRadius: "4px" }}>
          <h2 style={{ fontSize: "1rem", marginBottom: "0.5rem" }}>Adjusted risk tier</h2>
          <p style={{ marginBottom: "0.75rem" }}>{response.adjusted_risk_tier}</p>
          <h2 style={{ fontSize: "1rem", marginBottom: "0.5rem" }}>Reasoning</h2>
          <p style={{ marginBottom: "0.75rem" }}>{response.reasoning}</p>
          <h2 style={{ fontSize: "1rem", marginBottom: "0.5rem" }}>Recommended action</h2>
          <p>{response.recommended_action}</p>
        </div>
      )}
    </main>
  );
}
