"""Exploitability endpoint: per-vulnerability risk adjustment via local LLM (Ollama)."""

from fastapi import APIRouter, HTTPException

from app.core.config import get_settings
from app.schemas.exploitability import ExploitabilityOutput, ExploitabilityRequest
from app.services.exploitability import run_exploitability_reasoning
from app.services.reasoning import ReasoningServiceError

router = APIRouter()


@router.post("", response_model=ExploitabilityOutput)
async def post_exploitability(body: ExploitabilityRequest) -> ExploitabilityOutput:
    """
    Run exploitability reasoning for a single vulnerability.

    Sends vulnerability summary, CVSS score, repo context, dependency type, and
    exposure flags to the local LLM (Ollama). Returns adjusted_risk_tier,
    reasoning, and recommended_action as structured JSON.
    """
    settings = get_settings()
    try:
        result = await run_exploitability_reasoning(
            vulnerability_summary=body.vulnerability_summary,
            cvss_score=body.cvss_score,
            repo_context=body.repo_context,
            dependency_type=body.dependency_type,
            exposure_flags=body.exposure_flags,
            settings=settings,
        )
    except ReasoningServiceError as e:
        if "unreachable" in e.message.lower() or "timed out" in e.message.lower():
            raise HTTPException(status_code=503, detail=e.message) from e
        if "status" in e.message or "Ollama returned" in e.message:
            raise HTTPException(status_code=502, detail=e.message) from e
        raise HTTPException(status_code=422, detail=e.message) from e

    return result
